import machineManifestData from "../data/champagne_machine_manifest_full.json";
import navManifestData from "../data/manifest.nav.main.json";
import publicBrandManifest from "../data/manifest.public.brand.json";
import stylesManifest from "../data/manifest.styles.champagne.json";
import manusImportManifest from "../data/manus_import_unified_manifest_20251104.json";
import mediaDeckImplants from "../data/media-decks/media-deck.implants.json";
import journeySmileMakeover from "../data/journey.smile-makeover.json";
import sectionPageDefaults from "../data/sections/page-type.defaults.json";
import sectionFxDefaults from "../data/sections/section-fx.defaults.json";
import sectionPrmDefaults from "../data/sections/section-prm.defaults.json";
import sectionLibraryData from "../data/sections/section-library.json";
import sectionLayoutAligners from "../data/sections/smh/treatments.aligners.json";
import sectionLayoutClearAligners from "../data/sections/smh/treatments.clear-aligners.json";
import sectionLayoutSparkAligners from "../data/sections/smh/treatments.clear-aligners-spark.json";
import sectionLayoutImplantsTeethInADay from "../data/sections/smh/treatments.implants-teeth-in-a-day.json";
import sectionLayoutImplantsAftercare from "../data/sections/smh/treatments.implants-aftercare.json";
import sectionLayoutImplantsBoneGrafting from "../data/sections/smh/treatments.implants-bone-grafting.json";
import sectionLayoutImplantConsultation from "../data/sections/smh/treatments.implants-consultation.json";
import sectionLayoutFullArchImplants from "../data/sections/smh/treatments.implants-full-arch.json";
import sectionLayoutDentures from "../data/sections/smh/treatments.dentures.json";
import sectionLayoutAcrylicDentures from "../data/sections/smh/treatments.acrylic-dentures.json";
import sectionLayoutChromeDentures from "../data/sections/smh/treatments.chrome-dentures.json";
import sectionLayoutPeekPartialDentures from "../data/sections/smh/treatments.peek-partial-dentures.json";
import sectionLayoutImplantRetainedDentures from "../data/sections/smh/treatments.implants-retained-dentures.json";
import sectionLayoutMultiImplant from "../data/sections/smh/treatments.implants-multiple-teeth.json";
import sectionLayoutFailedImplantReplacement from "../data/sections/smh/treatments.implants-failed-replacement.json";
import sectionLayoutImplantSedation from "../data/sections/smh/treatments.implants-sedation.json";
import sectionLayoutImplantSinusLift from "../data/sections/smh/treatments.implants-sinus-lift.json";
import sectionLayoutSingleImplant from "../data/sections/smh/treatments.implants-single-tooth.json";
import sectionLayoutImplants from "../data/sections/smh/treatments.implants.json";
import sectionLayoutFixedBraces from "../data/sections/smh/treatments.fixed-braces.json";
import sectionLayout3DDentistryAndTechnology from "../data/sections/smh/treatments.3d-dentistry-and-technology.json";
import sectionLayout3DDigitalDentistry from "../data/sections/smh/treatments.3d-digital-dentistry.json";
import sectionLayoutNightGuardsOcclusalSplints from "../data/sections/smh/treatments.night-guards-occlusal-splints.json";
import sectionLayoutSportsMouthguards from "../data/sections/smh/treatments.sports-mouthguards.json";
import sectionLayoutDentalRetainers from "../data/sections/smh/treatments.dental-retainers.json";
import sectionLayout3DPrintedDentures from "../data/sections/smh/treatments.3d-printed-dentures.json";
import sectionLayout3DPrintedVeneers from "../data/sections/smh/treatments.3d-printed-veneers.json";
import sectionLayout3DImplantRestorations from "../data/sections/smh/treatments.3d-implant-restorations.json";
import sectionLayout3DPrintingLab from "../data/sections/smh/treatments.3d-printing-lab.json";
import sectionLayoutDigitalSmileDesign from "../data/sections/smh/treatments.digital-smile-design.json";
import sectionLayoutCbct3DScanning from "../data/sections/smh/treatments.cbct-3d-scanning.json";
import sectionLayoutDentalBridges from "../data/sections/smh/treatments.dental-bridges.json";
import sectionLayoutDentalCrowns from "../data/sections/smh/treatments.dental-crowns.json";
import sectionLayoutInlaysOnlays from "../data/sections/smh/treatments.inlays-onlays.json";
import sectionLayoutOrthodontics from "../data/sections/smh/treatments.orthodontics.json";
import sectionLayoutPainlessNumbingTheWand from "../data/sections/smh/treatments.painless-numbing-the-wand.json";
import sectionLayoutPeriodontalGumCare from "../data/sections/smh/treatments.periodontal-gum-care.json";
import sectionLayoutBruxismJawClenching from "../data/sections/smh/treatments.bruxism-and-jaw-clenching.json";
import sectionLayoutHomeTeethWhitening from "../data/sections/smh/treatments.home-teeth-whitening.json";
import sectionLayoutChildrensDentistry from "../data/sections/smh/treatments.childrens-dentistry.json";
import sectionLayoutNervousPatients from "../data/sections/smh/treatments.nervous-patients.json";
import sectionLayoutSedationDentistry from "../data/sections/smh/treatments.sedation-dentistry.json";
import sectionLayoutPreventativeGeneralDentistry from "../data/sections/smh/treatments.preventative-and-general-dentistry.json";
import sectionLayoutSeniorMatureSmileCare from "../data/sections/smh/treatments.senior-mature-smile-care.json";
import sectionLayoutTeethWhitening from "../data/sections/smh/treatments.teeth-whitening.json";
import sectionLayoutTeethWhiteningFaqs from "../data/sections/smh/treatments.teeth-whitening-faqs.json";
import sectionLayoutVeneers from "../data/sections/smh/treatments.veneers.json";
import sectionLayoutTmjJawComfort from "../data/sections/smh/treatments.tmj-jaw-comfort.json";
import sectionLayoutWhiteningSensitiveTeeth from "../data/sections/smh/treatments.whitening-sensitive-teeth.json";
import sectionLayoutWhiteningTopUps from "../data/sections/smh/treatments.whitening-top-ups.json";
import sectionLayoutFacialTherapeutics from "../data/sections/smh/treatments.facial-therapeutics.json";
import sectionLayoutFacialPainHeadache from "../data/sections/smh/treatments.facial-pain-and-headache.json";
import sectionLayoutFacialAesthetics from "../data/sections/smh/treatments.facial-aesthetics.json";
import sectionLayoutAntiWrinkleTreatments from "../data/sections/smh/treatments.anti-wrinkle-treatments.json";
import sectionLayoutDermalFillers from "../data/sections/smh/treatments.dermal-fillers.json";
import sectionLayoutSkinBoosters from "../data/sections/smh/treatments.skin-boosters.json";
import sectionLayoutPolynucleotides from "../data/sections/smh/treatments.polynucleotides.json";
import sectionLayoutTherapeuticInjectables from "../data/sections/smh/treatments.therapeutic-facial-injectables.json";
import sectionLayoutTmjDisorderTreatment from "../data/sections/smh/treatments.tmj-disorder-treatment.json";

export type ChampagneManifestStatus = "unavailable" | "stub" | "ready";

export interface ChampagnePageSection {
  id?: string;
  type?: string;
  label?: string;
  ctas?: (ChampagneCTA | string)[];
  [key: string]: unknown;
}

export interface ChampagneCTA {
  id?: string;
  label?: string;
  href?: string;
  preset?: string;
  [key: string]: unknown;
}

export interface ChampagnePageCTAConfig {
  heroCTAs?: (ChampagneCTA | string)[];
  midPageCTAs?: (ChampagneCTA | string)[];
  footerCTAs?: (ChampagneCTA | string)[];
  [key: string]: unknown;
}

export interface ChampagnePageManifest {
  id?: string;
  path?: string;
  hero?: string | Record<string, unknown>;
  sections?: ChampagnePageSection[] | string[];
  surface?: string;
  category?: string;
  label?: string;
  ctas?: ChampagnePageCTAConfig;
  [key: string]: unknown;
}

export interface ChampagneMachineManifest {
  id: string;
  note?: string;
  status: ChampagneManifestStatus | string;
  version: string;
  pages?: Record<string, ChampagnePageManifest>;
  treatments?: Record<string, ChampagnePageManifest>;
  [key: string]: unknown;
}

export interface ChampagneManifestRegistry {
  core: ChampagneMachineManifest;
  public?: unknown;
  styles?: unknown;
  manusImport?: unknown;
}

export interface ChampagneStylesManifest {
  heroes?: Record<string, unknown>;
  sections?: Record<string, unknown>;
  [key: string]: unknown;
}

export interface ChampagneSectionLibraryEntry {
  id: string;
  componentId: string;
  importPath?: string;
  defaultVariantId?: string;
  pageTypes?: string[];
  seoRole?: string;
  layoutRole?: string;
  brandTier?: string[];
  tokens?: Record<string, unknown>;
}

export interface ChampagneSectionLibrary {
  tenantId: string;
  version?: string;
  sections: ChampagneSectionLibraryEntry[];
}

export interface ChampagneSectionLayoutVisibility {
  minBreakpoint?: string;
  maxBreakpoint?: string;
  featureFlags?: string[];
}

export interface ChampagneSectionLayoutSection {
  instanceId: string;
  componentId: string;
  variantId?: string;
  order: number;
  slot?: string;
  seoRole?: string;
  visibility?: ChampagneSectionLayoutVisibility;
  propsRef?: string;
  experiments?: { abTestId?: string; variantKey?: string };
  [key: string]: unknown;
}

export interface ChampagneSectionLayout {
  tenantId: string;
  routeId: string;
  pageType: string;
  version?: string;
  sections: ChampagneSectionLayoutSection[];
}

export interface ChampagnePageTypeDefault {
  pageType: string;
  routeId: string;
  tenantId: string;
  sectionOrder: string[];
}

export interface ChampagnePageTypeDefaults {
  version?: string;
  pageDefaults?: ChampagnePageTypeDefault[];
}

export interface ChampagneJourneyStep {
  id: string;
  componentId: string;
  variantId?: string;
  order?: number;
  uiHints?: { layout?: string; emotionalLightingPreset?: string; persona?: string };
  eventsOnComplete?: string[];
}

export interface ChampagneJourneyTransitionConditions {
  quizAnswersInclude?: string[];
  tagsInclude?: string[];
}

export interface ChampagneJourneyTransition {
  on: string;
  targetStateId: string;
  conditions?: ChampagneJourneyTransitionConditions;
}

export interface ChampagneJourneyState {
  id: string;
  label: string;
  kind?: "educational" | "calming" | "exploratory" | "post-consult" | "finance";
  steps: ChampagneJourneyStep[];
  transitions?: ChampagneJourneyTransition[];
}

export interface ChampagneJourneyManifest {
  journeyId: string;
  tenantId: string;
  label?: string;
  description?: string;
  entryConditions?: { routes?: string[]; tags?: string[] };
  states: ChampagneJourneyState[];
  exitConditions?: { onCompletedStates?: string[] };
}

export interface ChampagneMediaDeckManifest {
  mediaDeckId: string;
  tenantId: string;
  usage: { primaryRouteId?: string; context?: string[] };
  assets: {
    heroLoop?: string;
    heroStill?: string;
    backgroundLoops?: string[];
    broll?: string[];
    viewer3d?: string[];
  };
  prmVariants?: { staticHero?: string; staticBackgrounds?: string[] };
  captions?: { id: string; label: string; usageHint?: string }[];
}

export interface NavItem {
  id: string;
  label: string;
  href: string;
  priority?: number;
  status?: "live" | "stub";
}

export interface ChampagneNavigationManifest {
  items?: NavItem[];
  [key: string]: unknown;
}

export interface ChampagneSectionFxDefaultsEntry {
  parallax?: boolean | number;
  fadeIn?: boolean;
  spotlight?: boolean;
  shimmer?: boolean;
}

export interface ChampagneSectionFxDefaultsManifest {
  id: string;
  description?: string;
  version?: number;
  fxDefaults?: Record<string, ChampagneSectionFxDefaultsEntry>;
}

export interface ChampagneSectionPrmDefaultsEntry {
  reduceParallaxTo?: number;
  disableShimmer?: boolean;
  disableSpotlight?: boolean;
  softFadeOnly?: boolean;
}

export interface ChampagneSectionPrmDefaultsManifest {
  id: string;
  description?: string;
  version?: number;
  prmRules?: Record<string, ChampagneSectionPrmDefaultsEntry>;
}

const champagneMachineManifest: ChampagneMachineManifest = machineManifestData;
const champagneStylesManifest: ChampagneStylesManifest = stylesManifest;
const champagneNavigationManifest: ChampagneNavigationManifest = {
  ...navManifestData,
  items: (navManifestData.items ?? []).map((item) => ({
    ...item,
    status: item.status === "stub" ? "stub" : item.status === "live" ? "live" : undefined,
  })),
};

const registry: ChampagneManifestRegistry = {
  core: champagneMachineManifest,
  public: publicBrandManifest,
  styles: stylesManifest,
  manusImport: manusImportManifest,
};

export const champagneSectionLibrary: ChampagneSectionLibrary = sectionLibraryData;
export const champagneSectionLayouts: ChampagneSectionLayout[] = [
  sectionLayoutImplantsAftercare as ChampagneSectionLayout,
  sectionLayoutImplantsBoneGrafting as ChampagneSectionLayout,
  sectionLayoutImplantsTeethInADay as ChampagneSectionLayout,
  sectionLayoutImplantConsultation as ChampagneSectionLayout,
  sectionLayoutFailedImplantReplacement as ChampagneSectionLayout,
  sectionLayoutImplantSedation as ChampagneSectionLayout,
  sectionLayoutImplantSinusLift as ChampagneSectionLayout,
  sectionLayoutMultiImplant as ChampagneSectionLayout,
  sectionLayoutSingleImplant as ChampagneSectionLayout,
  sectionLayoutFullArchImplants as ChampagneSectionLayout,
  sectionLayoutDentures as ChampagneSectionLayout,
  sectionLayoutAcrylicDentures as ChampagneSectionLayout,
  sectionLayoutChromeDentures as ChampagneSectionLayout,
  sectionLayoutPeekPartialDentures as ChampagneSectionLayout,
  sectionLayoutImplantRetainedDentures as ChampagneSectionLayout,
  sectionLayoutImplants as ChampagneSectionLayout,
  sectionLayoutVeneers as ChampagneSectionLayout,
  sectionLayoutFixedBraces as ChampagneSectionLayout,
  sectionLayoutOrthodontics as ChampagneSectionLayout,
  sectionLayoutClearAligners as ChampagneSectionLayout,
  sectionLayoutSparkAligners as ChampagneSectionLayout,
  sectionLayoutAligners as ChampagneSectionLayout,
  sectionLayout3DDentistryAndTechnology as ChampagneSectionLayout,
  sectionLayout3DDigitalDentistry as ChampagneSectionLayout,
  sectionLayoutNightGuardsOcclusalSplints as ChampagneSectionLayout,
  sectionLayoutSportsMouthguards as ChampagneSectionLayout,
  sectionLayout3DPrintedDentures as ChampagneSectionLayout,
  sectionLayout3DPrintedVeneers as ChampagneSectionLayout,
  sectionLayout3DImplantRestorations as ChampagneSectionLayout,
  sectionLayout3DPrintingLab as ChampagneSectionLayout,
  sectionLayoutDigitalSmileDesign as ChampagneSectionLayout,
  sectionLayoutCbct3DScanning as ChampagneSectionLayout,
  sectionLayoutDentalBridges as ChampagneSectionLayout,
  sectionLayoutDentalCrowns as ChampagneSectionLayout,
  sectionLayoutInlaysOnlays as ChampagneSectionLayout,
  sectionLayoutPainlessNumbingTheWand as ChampagneSectionLayout,
  sectionLayoutPeriodontalGumCare as ChampagneSectionLayout,
  sectionLayoutBruxismJawClenching as ChampagneSectionLayout,
  sectionLayoutHomeTeethWhitening as ChampagneSectionLayout,
  sectionLayoutChildrensDentistry as ChampagneSectionLayout,
  sectionLayoutNervousPatients as ChampagneSectionLayout,
  sectionLayoutSedationDentistry as ChampagneSectionLayout,
  sectionLayoutPreventativeGeneralDentistry as ChampagneSectionLayout,
  sectionLayoutSeniorMatureSmileCare as ChampagneSectionLayout,
  sectionLayoutTeethWhitening as ChampagneSectionLayout,
  sectionLayoutTeethWhiteningFaqs as ChampagneSectionLayout,
  sectionLayoutDentalRetainers as ChampagneSectionLayout,
  sectionLayoutTmjJawComfort as ChampagneSectionLayout,
  sectionLayoutTmjDisorderTreatment as ChampagneSectionLayout,
  sectionLayoutWhiteningSensitiveTeeth as ChampagneSectionLayout,
  sectionLayoutWhiteningTopUps as ChampagneSectionLayout,
  sectionLayoutFacialTherapeutics as ChampagneSectionLayout,
  sectionLayoutFacialPainHeadache as ChampagneSectionLayout,
  sectionLayoutFacialAesthetics as ChampagneSectionLayout,
  sectionLayoutAntiWrinkleTreatments as ChampagneSectionLayout,
  sectionLayoutDermalFillers as ChampagneSectionLayout,
  sectionLayoutSkinBoosters as ChampagneSectionLayout,
  sectionLayoutPolynucleotides as ChampagneSectionLayout,
  sectionLayoutTherapeuticInjectables as ChampagneSectionLayout,
];
export const champagnePageTypeDefaults: ChampagnePageTypeDefaults = sectionPageDefaults;
export const champagneSectionFxDefaults: ChampagneSectionFxDefaultsManifest = sectionFxDefaults;
export const champagneSectionPrmDefaults: ChampagneSectionPrmDefaultsManifest = sectionPrmDefaults;
export const champagneJourneyManifests: ChampagneJourneyManifest[] = [
  journeySmileMakeover as ChampagneJourneyManifest,
];
export const champagneMediaDeckManifests: ChampagneMediaDeckManifest[] = [
  mediaDeckImplants as ChampagneMediaDeckManifest,
];

type StatusCarrier = { status?: ChampagneManifestStatus | string };

const manifestStatuses = [
  champagneMachineManifest.status,
  (registry.public as StatusCarrier | undefined)?.status,
  (registry.styles as StatusCarrier | undefined)?.status,
  (registry.manusImport as StatusCarrier | undefined)?.status,
];

const allReady = manifestStatuses.every((status) => status === "ready");

export const champagneManifestStatus: ChampagneManifestStatus = allReady
  ? "ready"
  : champagneMachineManifest.status === "ready"
    ? "stub"
    : "unavailable";

export const champagneManifestsReady = champagneManifestStatus === "ready";

export const champagneManifestRegistry: ChampagneManifestRegistry = registry;
export { champagneStylesManifest };

const pageCollections = [
  champagneMachineManifest.pages ?? {},
  champagneMachineManifest.treatments ?? {},
];

function normalizeSlug(slug: string): string {
  if (!slug) return "/";
  return slug.startsWith("/") ? slug : `/${slug}`;
}

export function getRouteIdFromSlug(slug: string): string {
  const normalized = normalizeSlug(slug).replace(/^\//, "").replace(/\/$/, "");
  if (!normalized) return "home";
  return normalized.replace(/\//g, ".");
}

const sectionComponentTypeMap: Record<string, string> = {
  section_treatment_intro: "treatment_overview_rich",
  section_before_after_grid: "gallery",
  section_implant_steps: "features",
  section_finance_summary: "features",
  section_faq: "treatment_faq_block",
  section_contact_cta: "treatment_closing_cta",
  "treatment.heroIntro": "treatment_overview_rich",
  "treatment.trustSignals": "features",
  "treatment.consultationOverview": "treatment_overview_rich",
  "treatment.whatAreImplants": "treatment_media_feature",
  "treatment.whoIsItFor": "features",
  "treatment.processTimeline": "features",
  "treatment.technology": "treatment_media_feature",
  "technology.digitalScanning": "treatment_media_feature",
  "technology.digitalSmileDesign": "treatment_media_feature",
  "technology.inHouse3DPrinting": "treatment_media_feature",
  "technology.handFinishedAesthetics": "treatment_media_feature",
  "technology.caseSelection": "features",
  "treatment.pricingFinance": "features",
  "treatment.aftercareRisks": "features",
  "treatment.faq": "treatment_faq_block",
  "treatment.cta": "treatment_closing_cta",
};

function buildSectionsFromLayout(manifest: ChampagneSectionLayout): ChampagnePageSection[] {
  const sortedSections = [...(manifest.sections ?? [])].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

  return sortedSections
    .filter((section) => !section.componentId?.startsWith("hero_"))
    .map((section, index) => {
      const { instanceId, componentId, variantId, order, slot, seoRole, visibility, propsRef, experiments, ...definition } =
        section;
      const type = sectionComponentTypeMap[section.componentId] ?? section.componentId;
      return {
        id: instanceId || `${manifest.routeId}-section-${index + 1}`,
        type,
        componentId,
        variantId,
        order,
        slot,
        seoRole,
        visibility,
        propsRef,
        experiments,
        ...definition,
      } satisfies ChampagnePageSection;
    });
}

function getSectionLayoutByRoute(routeId: string): ChampagneSectionLayout | undefined {
  return champagneSectionLayouts.find((entry) => entry.routeId === routeId);
}

function getPageTypeDefault(routeId: string): ChampagnePageTypeDefault | undefined {
  return champagnePageTypeDefaults.pageDefaults?.find((entry) => entry.routeId === routeId);
}

function buildSectionsFromDefaults(pageDefault: ChampagnePageTypeDefault): ChampagnePageSection[] {
  return (pageDefault.sectionOrder ?? []).map((componentId, index) => ({
    id: `${pageDefault.routeId}-section-${index + 1}`,
    type: componentId,
    componentId,
    order: (index + 1) * 10,
  }));
}

export function getMainNavItems(): NavItem[] {
  const items = champagneNavigationManifest.items ?? [];
  return [...items].sort((a, b) => {
    const priorityA = a.priority ?? Number.MAX_SAFE_INTEGER;
    const priorityB = b.priority ?? Number.MAX_SAFE_INTEGER;
    if (priorityA !== priorityB) return priorityA - priorityB;
    return a.label.localeCompare(b.label);
  });
}

export function getPageManifestBySlug(slug: string): ChampagnePageManifest | undefined {
  const normalizedSlug = normalizeSlug(slug);

  for (const collection of pageCollections) {
    const match = Object.values(collection).find((entry) => entry.path === normalizedSlug);
    if (match) return match;
  }
  return undefined;
}

export function getHeroPresetForPage(slug: string): string | Record<string, unknown> | undefined {
  return getPageManifestBySlug(slug)?.hero;
}

export function getSectionStackForPage(slug: string): (ChampagnePageSection | string)[] | undefined {
  const normalizedSlug = normalizeSlug(slug);
  const routeId = getRouteIdFromSlug(normalizedSlug);

  const sectionLayout = getSectionLayoutByRoute(routeId);
  if (process.env.NODE_ENV !== "production") {
    console.info("[sections][resolver-dev-receipt][remove-if-no-longer-needed]", {
      routeId,
      smhManifestFound: Boolean(sectionLayout),
      smhSectionCount: sectionLayout?.sections?.length ?? 0,
    });
  }
  if (sectionLayout) {
    return buildSectionsFromLayout(sectionLayout);
  }

  const pageManifest = getPageManifestBySlug(normalizedSlug);
  if (pageManifest?.sections) {
    return pageManifest.sections;
  }

  const defaultEntry = getPageTypeDefault(routeId);
  if (defaultEntry) {
    return buildSectionsFromDefaults(defaultEntry);
  }

  return undefined;
}

export { champagneMachineManifest };
