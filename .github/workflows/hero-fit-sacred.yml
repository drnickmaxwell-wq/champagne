name: Sacred Hero Fit

on:
  workflow_dispatch:
    inputs:
      run_hero_fit:
        description: "Run Sacred Hero fitting"
        type: boolean
        default: true
  schedule:
    - cron: "0 3 * * *"
  pull_request:
    paths:
      - scripts/hero_fit_sacred.mjs
      - packages/champagne-manifests/data/hero/sacred_hero_surfaces.json
      - public/assets/champagne/**

concurrency:
  group: sacred-hero-fit
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  fit:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_hero_fit == true }}
    timeout-minutes: 25
    env:
      HERO_FIT_CANDIDATE_LIMIT: "48"
      HERO_FIT_SEED: "sacred-ci"
      HERO_FIT_DPR: "1"
      HERO_FIT_MOTION_MS: "450"
      HERO_FIT_VIEWPORT: "1920x1080"
    outputs:
      has_report: ${{ steps.report-check.outputs.has_report }}
      has_best: ${{ steps.report-check.outputs.has_best }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"
          run_install: false

      - name: Get pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install
        timeout-minutes: 10
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium
        timeout-minutes: 15
        run: pnpm exec playwright install --with-deps chromium

      - name: Run sacred hero fit
        timeout-minutes: 20
        run: pnpm run hero:fit:sacred

      - name: Print winner
        if: ${{ always() }}
        run: |
          node -e "const fs=require('fs');const r=JSON.parse(fs.readFileSync('reports/hero-fit/report.json','utf8'));const c=r.best?.candidate;console.log('best.candidate',c);if(c){console.log('caustics',c.causticsBlend,c.causticsOpacity);console.log('shimmer',c.shimmerBlend,c.shimmerOpacity);}else{process.exit(1);}"

      - name: Check hero fit report
        id: report-check
        if: ${{ always() }}
        run: |
          node -e "const fs=require('fs');const p='reports/hero-fit/report.json';const out=[];if(!fs.existsSync(p)){out.push('has_report=false');out.push('has_best=false');}else{const r=JSON.parse(fs.readFileSync(p,'utf8'));const hasBest=Boolean(r.best && r.best.candidate);out.push('has_report=true');out.push('has_best=' + hasBest);}fs.appendFileSync(process.env.GITHUB_OUTPUT, out.join('\\n') + '\\n');"

      - name: Upload hero fit artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: hero-fit-report
          path: reports/hero-fit/**
          if-no-files-found: warn

  guard_pr:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"
          run_install: false

      - name: Install
        timeout-minutes: 10
        run: pnpm install --frozen-lockfile

      - name: Guard hero
        run: pnpm run guard:hero

      - name: Guard canon
        run: pnpm run guard:canon

      - name: Verify
        run: pnpm run verify

  apply_winner_pr:
    runs-on: ubuntu-latest
    needs: fit
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_hero_fit == true && needs.fit.outputs.has_report == 'true' && needs.fit.outputs.has_best == 'true' }}
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"
          run_install: false

      - name: Install
        timeout-minutes: 10
        run: pnpm install --frozen-lockfile

      - name: Download hero fit artifacts
        uses: actions/download-artifact@v4
        with:
          name: hero-fit-report
          path: reports/hero-fit

      - name: Validate hero fit report
        run: test -f reports/hero-fit/report.json

      - name: Apply winner to manifest
        run: node scripts/hero_fit_apply_winner.mjs

      - name: Guard hero
        run: pnpm run guard:hero

      - name: Guard canon
        run: pnpm run guard:canon

      - name: Verify
        run: pnpm run verify

      - name: Prepare PR body
        run: |
          node -e "const fs=require('fs');const r=JSON.parse(fs.readFileSync('reports/hero-fit/report.json','utf8'));const c=r.best?.candidate||{};const snippet=JSON.stringify(c,null,2);const body=[\
          '## Sacred Hero Fit Winner',\
          '',\
          '```json',\
          snippet,\
          '```',\
          '',\
          'Artifacts: reports/hero-fit/best.png, reports/hero-fit/top_12_grid.png, reports/hero-fit/motion_delta.png, reports/hero-fit/report.json, reports/hero-fit/results.json',\
          '',\
          'Download the artifacts from the workflow run (Actions → Sacred Hero Fit → Artifacts).',\
          '',\
          'No engine/components/tokens/CTA/typography changes.'\
          ].join('\\n');fs.writeFileSync('reports/hero-fit/pr-body.md',body);"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "bot/hero-fit-sacred-${{ github.sha }}"
          commit-message: "chore(hero): apply sacred fit winner"
          title: Apply Sacred Hero Fit Winner
          body-path: reports/hero-fit/pr-body.md
